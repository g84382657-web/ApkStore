<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APK Store</title>

    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); color: white; min-height: 100vh; }
        .container { padding-bottom: 90px; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 2px solid #00eeff; background: rgba(0,0,0,0.2); }
        .header h1 { font-size: 22px; color: #00eeff; text-shadow: 0 0 12px #00eeff; }
        #searchInput { padding: 10px 14px; border-radius: 25px; border: none; outline: none; width: 170px; display: none; background: rgba(255,255,255,0.1); color: white; }

        /* UI ELEMENTS */
        .page { display: none; padding: 20px; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .active-page { display: block; }
        
        .form-container { background: rgba(255, 255, 255, .07); padding: 30px; border-radius: 18px; max-width: 420px; margin: 40px auto; border: 1px solid rgba(255,255,255,0.1); }
        .form-input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 2px solid #00eeff; background: rgba(255, 255, 255, .05); color: white; outline: none; }
        
        .neon-btn { background: transparent; border: 2px solid; padding: 14px; border-radius: 30px; cursor: pointer; font-weight: bold; transition: .3s; text-transform: uppercase; }
        .login-btn { border-color: #00eeff; color: #00eeff; box-shadow: 0 0 8px #00eeff; }
        .register-btn { border-color: #ff00cc; color: #ff00cc; box-shadow: 0 0 8px #ff00cc; }
        .nav-btn { border-color: #ffaa00; color: #ffaa00; width: 30%; font-size: 12px; }

        .dev-card-new { margin: 20px auto; background: rgba(255, 255, 255, 0.05); padding: 30px 20px; border-radius: 25px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 0 30px rgba(255, 170, 0, 0.15); text-align: center; max-width: 350px; }
        .dev-card-new h2 { color: #ffaa00; text-shadow: 0 0 10px #ffaa00; font-size: 22px; margin-bottom: 10px; text-transform: uppercase; }
        .dev-card-new p { font-size: 15px; color: #e0e0e0; line-height: 1.5; margin-bottom: 25px; }
        
        .activate-pink-btn { background: transparent; color: #FF00FF; border: 3px solid #FF00FF; border-radius: 50px; padding: 12px 0; width: 90%; font-size: 18px; font-weight: bold; cursor: pointer; text-transform: uppercase; box-shadow: 0 0 15px rgba(255, 0, 255, 0.5), inset 0 0 5px rgba(255, 0, 255, 0.3); transition: 0.3s ease-in-out; }
        .activate-pink-btn:hover { background: #FF00FF; color: white; box-shadow: 0 0 25px rgba(255, 0, 255, 0.8); }

        /* MESSAGE BOX SYSTEM - FIXED & SCROLLABLE */
        #userMessageBox { margin-top: 20px; padding: 0 15px; }
        .msg-container { 
            background: rgba(0, 238, 255, 0.05); 
            border: 1px solid #00eeff; 
            border-radius: 15px; 
            padding: 15px; 
            text-align: left; 
            animation: slideUp 0.5s ease;
            max-height: 250px; /* Fixed height for the card */
            overflow-y: auto;  /* Vertical scroll if many messages */
            overflow-x: hidden;
        }

        /* Custom Scrollbar for better look */
        .msg-container::-webkit-scrollbar { width: 4px; }
        .msg-container::-webkit-scrollbar-thumb { background: #00eeff; border-radius: 10px; }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .msg-item { 
            background: rgba(255,255,255,0.05); 
            padding: 10px; 
            border-radius: 10px; 
            margin-bottom: 8px; 
            border-left: 3px solid #ff00cc;
            overflow-x: auto; /* Horizontal scroll for long words */
            white-space: nowrap; /* Keeps long text in one line for horizontal scroll */
        }
        
        .msg-text { font-size: 14px; color: #fff; line-height: 1.4; display: inline-block; }
        .msg-time { font-size: 10px; color: #aaa; margin-top: 5px; text-align: right; display: block; }

        .app-card { background: rgba(255, 255, 255, 0.08); padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; border-left: 5px solid #00eeff; transition: 0.3s; }
        .app-card:hover { transform: scale(1.02); background: rgba(255, 255, 255, 0.12); }
        .app-icon { width: 60px; height: 60px; border-radius: 14px; object-fit: cover; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); }
        .app-info { flex: 1; }
        .app-info h3 { font-size: 18px; color: #fff; margin-bottom: 4px; }
        .app-info p { font-size: 12px; color: #00eeff; font-weight: bold; }
        .download-btn { background: #00ff88; color: #000; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; text-decoration: none; font-size: 13px; }

        .profile-page-bg { background: linear-gradient(135deg, #021b2f, #043d5a, #021b2f); min-height: 100vh; padding-bottom: 120px; }
        .logout-btn { position: absolute; top: 15px; right: 15px; border: 2px solid #ff5555; color: #ff5555; padding: 8px 16px; border-radius: 25px; background: transparent; cursor: pointer; }
        .avatar { width: 90px; height: 90px; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 35px; background: #b57bff; color: white; border: 3px solid #fff; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: space-around; padding: 14px; background: #100e30; border-top: 2px solid #00eeff; z-index: 100; }
    </style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>APK STORE</h1>
        <input id="searchInput" placeholder="Search apps..." onkeyup="searchApps()">
    </div>

    <div id="loginPage" class="page active-page">
       <h2 style="color:#ffaa00; text-align:center; margin-top:20px;">Welcome to APK Store</h2>
        <div class="form-container">
         <h2>LOGIN</h2>
            <input id="loginEmail" class="form-input" placeholder="Email Address">
            <input id="loginPassword" type="password" class="form-input" placeholder="Password">
            <button class="neon-btn login-btn" style="width:100%" onclick="login()">LOGIN</button>
            <p style="margin-top:18px; text-align:center; color:#aaa">Don't have an account? <span style="color:#00eeff; cursor:pointer;" onclick="showPage('registerPage')">REGISTER</span></p>
        </div>
    </div>

    <div id="registerPage" class="page">
       <h2 style="color:#ffaa00; text-align:center; margin-top:20px;">Welcome to APK Store</h2>
        <div class="form-container">
              <h2>REGISTER</h2>
            <input id="registerName" class="form-input" placeholder="Full Name">
            <input id="registerEmail" class="form-input" placeholder="Email Address">
            <input id="registerPassword" type="password" class="form-input" placeholder="Password">
            <button class="neon-btn register-btn" style="width:100%" onclick="register()">Create Account</button>
            <p style="margin-top:18px; text-align:center; color:#aaa">Already a member? <span style="color:#00eeff; cursor:pointer;" onclick="showPage('loginPage')">Login</span></p>
        </div>
    </div>

    <div id="appsPage" class="page"> <h2 style="color:#ffaa00; margin-bottom:20px;">Featured Apps</h2> <div id="appsList"></div> </div>
    <div id="gamesPage" class="page"> <h2 style="color:#ffaa00; margin-bottom:20px;">Popular Games</h2> <div id="gamesList"></div> </div>

    <div id="profilePage" class="page profile-page-bg">
        <button class="logout-btn" onclick="logout()">Logout</button>
        <div style="text-align: center; padding-top: 40px;">
            <div class="avatar" id="profileAvatar">?</div>
            <h2 id="profileName" style="margin-bottom:5px;">User</h2>
            <p id="profileEmail" style="color:#aaa; font-size:14px; margin-bottom:20px;">---</p>
            
            <div id="devStatusBox" style="margin:15px 0;">
                Status: <span id="devStatus" style="font-weight:bold;">CHECKING...</span>
            </div>

            <div id="devCard" style="padding:0 10px;">
                <div class="dev-card-new">
                    <h2>Become a Developer</h2>
                    <p>Activate developer account to upload APKs.<br>One-time payment <b>₹499</b> only.</p>
                    <button class="activate-pink-btn" onclick="showPage('paymentPage')">Activate</button>
                </div>
            </div>

            <div id="userMessageBox">
                <div class="msg-container">
                    <h4 style="color:#00eeff; font-size:14px; margin-bottom:10px; border-bottom:1px solid rgba(0,238,255,0.2); padding-bottom:5px;">
                        ADMIN MESSAGES
                    </h4>
                    <div id="messagesDisplay">
                        <p style="font-size:12px; color:#666;">No new messages from admin.</p>
                    </div>
                </div>
            </div>

            <div id="uploadSection" style="display:none; padding:0 20px; text-align:left;">
                <div class="form-container" style="margin-top:10px; max-width:100%;">
                    <h3 style="color:#00eeff; margin-bottom:15px; text-align:center;">PUBLISH NEW APK</h3>
                    <label style="font-size:12px; color:#aaa;">App/Game Name</label>
                    <input id="apkName" class="form-input" placeholder="e.g. WhatsApp Pro">
                    <label style="font-size:12px; color:#aaa;">App Icon Link</label>
                    <input id="apkIcon" class="form-input" placeholder="https://image-link.com/logo.png">
                    <label style="font-size:12px; color:#aaa;">Download Link</label>
                    <input id="apkUrl" class="form-input" placeholder="Direct link">
                    <label style="font-size:12px; color:#aaa;">Select Category</label>
                    <select id="apkCat" class="form-input">
                        <option value="Apps">Apps</option>
                        <option value="Games">Games</option>
                    </select>
                    <button id="uploadBtn" class="neon-btn login-btn" style="width:100%; margin-top:10px;" onclick="userUploadApk()">PUBLISH NOW</button>
                </div>
            </div>
        </div>
    </div>

    <div id="paymentPage" class="page">
        <div class="form-container" style="text-align:center;">
            <h2 style="color:#ffaa00;">SECURE PAYMENT</h2>
            <div style="background:white; padding:15px; display:inline-block; border-radius:10px; margin:20px 0; border: 3px solid #00eeff;">
                <img src="https://i.postimg.cc/68njb9ML/qr.png" width="180" alt="QR Code">
            </div>
            <p style="font-size:14px; margin-bottom:15px; color:#ccc;">Scan & Pay <b>₹499</b> to become a Developer.</p>
            <input id="payUtr" class="form-input" placeholder="Enter UTR / Transaction ID" style="border-color: #ff00cc;">
            <input id="payEmail" class="form-input" placeholder="Confirm Your Registered Email" style="border-color: #ff00cc;">
            <button class="neon-btn login-btn" style="width:100%; margin-top: 10px;" onclick="submitPaymentRequest()">SUBMIT DETAILS</button>
            <p onclick="showPage('profilePage')" style="margin-top:15px; cursor:pointer; color:#ff5555; font-size: 14px;">Go Back</p>
        </div>
    </div>

    <div class="bottom-nav" id="bottomNav" style="display:none">
        <button class="neon-btn nav-btn" onclick="showPage('appsPage')">APPS</button>
        <button class="neon-btn nav-btn" onclick="showPage('gamesPage')">GAMES</button>
        <button class="neon-btn nav-btn" onclick="showPage('profilePage')">PROFILE</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAmvyN2cqsgsGaYCUx1U2YhwWQy-7X76fo",
        authDomain: "solver-b2a3c.firebaseapp.com",
        databaseURL: "https://solver-b2a3c-default-rtdb.firebaseio.com",
        projectId: "solver-b2a3c",
        storageBucket: "solver-b2a3c.firebasestorage.app",
        messagingSenderId: "759476950326",
        appId: "1:759476950326:web:5d8b354152d554ddef4f97"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(id).classList.add('active-page');
        document.getElementById('searchInput').style.display = (id === 'appsPage' || id === 'gamesPage') ? 'block' : 'none';
        document.getElementById('bottomNav').style.display = (id === 'loginPage' || id === 'registerPage') ? 'none' : 'flex';
        window.scrollTo(0,0);
    }

    auth.onAuthStateChanged(user => {
        if (user) { 
            fetchUserProfile(user); 
            listenForMessages(user.uid); 
            loadAppsData();
            const current = document.querySelector('.active-page').id;
            if(current === 'loginPage' || current === 'registerPage') showPage('appsPage');
        } else { 
            showPage('loginPage'); 
        }
    });

    function listenForMessages(userId) {
        const cutoff = new Date();
        cutoff.setHours(cutoff.getHours() - 48);
        const cutoffISO = cutoff.toISOString();

        db.collection("messages")
          .where("toUser", "==", userId)
          .where("time", ">=", cutoffISO) 
          .orderBy("time", "desc")
          .onSnapshot(snapshot => {
            const msgDisplay = document.getElementById('messagesDisplay');
            if (snapshot.empty) {
                msgDisplay.innerHTML = `<p style="font-size:12px; color:#666;">No recent messages from admin.</p>`;
                return;
            }
            
            let html = "";
            snapshot.forEach(doc => {
                const data = doc.data();
                const time = new Date(data.time).toLocaleString();
                html += `
                    <div class="msg-item">
                        <p class="msg-text">${data.message}</p>
                        <p class="msg-time">${time}</p>
                    </div>
                `;
            });
            msgDisplay.innerHTML = html;
        }, err => {
            console.error("Firestore Error:", err);
        });
    }

    function login() {
        const e = document.getElementById('loginEmail').value;
        const p = document.getElementById('loginPassword').value;
        if(!e || !p) return alert("Enter credentials");
        auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
    }

    function register() {
        const n = document.getElementById('registerName').value;
        const e = document.getElementById('registerEmail').value;
        const p = document.getElementById('registerPassword').value;
        if(!n || !e || !p) return alert("Fill all details");
        auth.createUserWithEmailAndPassword(e, p).then(res => {
            db.collection("users").doc(res.user.uid).set({
                name: n, email: e, isDeveloper: false, paymentStatus: "none", joinedAt: new Date().toISOString()
            });
        }).catch(err => alert(err.message));
    }

    function logout() { auth.signOut(); }

    function fetchUserProfile(user) {
        db.collection("users").doc(user.uid).onSnapshot(doc => {
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('profileName').innerText = data.name;
                document.getElementById('profileEmail').innerText = data.email;
                document.getElementById('profileAvatar').innerText = data.name.charAt(0).toUpperCase();
                
                const devStatus = document.getElementById('devStatus');
                const devCard = document.getElementById('devCard');
                const uploadSec = document.getElementById('uploadSection');

                if(data.isDeveloper) {
                    devStatus.innerText = "ACTIVE DEVELOPER";
                    devStatus.style.color = "#00ff88";
                    devCard.style.display = "none";
                    uploadSec.style.display = "block";
                } else {
                    if(data.paymentStatus === "pending") {
                        devStatus.innerText = "PENDING APPROVAL";
                        devStatus.style.color = "#ffaa00";
                        devCard.style.display = "none";
                    } else {
                        devStatus.innerText = "INACTIVE";
                        devStatus.style.color = "#ff5555";
                        devCard.style.display = "block";
                    }
                    uploadSec.style.display = "none";
                }
            }
        });
    }

    function userUploadApk() {
        const name = document.getElementById('apkName').value.trim();
        const icon = document.getElementById('apkIcon').value.trim();
        const url = document.getElementById('apkUrl').value.trim();
        const cat = document.getElementById('apkCat').value;
        if(!name || !icon || !url) return alert("Please fill all fields!");
        db.collection("apks").add({
            name: name, icon: icon, url: url, category: cat,
            devName: document.getElementById('profileName').innerText,
            uploadedBy: auth.currentUser.uid, time: new Date().toISOString()
        }).then(() => {
            alert("App published!");
            showPage('appsPage');
        });
    }

    function loadAppsData() {
        db.collection("apks").orderBy("time", "desc").onSnapshot(snapshot => {
            const appsList = document.getElementById('appsList');
            const gamesList = document.getElementById('gamesList');
            appsList.innerHTML = ""; gamesList.innerHTML = "";
            snapshot.forEach(doc => {
                const data = doc.data();
                const card = `
                    <div class="app-card">
                        <img src="${data.icon}" class="app-icon" onerror="this.src='https://cdn-icons-png.flaticon.com/512/5132/5132144.png'">
                        <div class="app-info"><h3>${data.name}</h3><p>DEV: ${data.devName || 'Verified'}</p></div>
                        <button class="download-btn" onclick="window.open('${data.url}', '_blank')">GET</button>
                    </div>`;
                if(data.category === "Apps") appsList.innerHTML += card;
                else gamesList.innerHTML += card;
            });
        });
    }

    function searchApps() {
        let q = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.app-card').forEach(card => {
            let title = card.querySelector('h3').innerText.toLowerCase();
            card.style.display = title.includes(q) ? "flex" : "none";
        });
    }

    function submitPaymentRequest() {
        const utr = document.getElementById('payUtr').value.trim();
        const email = document.getElementById('payEmail').value.trim();
        if(!utr || !email) return alert("Please enter both UTR and Email Address!");

        db.collection("users").doc(auth.currentUser.uid).update({ 
            paymentStatus: "pending",
            submittedUtr: utr,
            submittedEmail: email,
            requestTime: new Date().toISOString()
        })
        .then(() => { 
            alert("Payment details submitted successfully! Admin will verify it soon."); 
            showPage('profilePage'); 
        })
        .catch(err => alert("Error: " + err.message));
    }
</script>
</body>
</html>
